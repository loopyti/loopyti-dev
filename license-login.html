<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ìš”ì†Œ ì œì‘ë´‡GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      padding: 2rem;
      max-width: 480px;
      margin: auto;
      text-align: center;
    }
    h1 { margin-bottom: 1rem; }
    .step {
      margin: 1rem 0;
      padding: 1rem;
      border: 1px solid #ddd;
      border-radius: 12px;
    }
    input, button {
      padding: .7rem 1rem;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: .5rem;
    }
    button {
      background: #4CAF50;
      color: white;
      cursor: pointer;
      border: none;
      font-size: 1rem;
    }
    button:hover { background: #45a049; }
    #status {
      margin-top: 1rem;
      font-weight: bold;
      white-space: pre-line;
    }
    #logoutBtn {
      background:#e74c3c;
      margin-top:1rem;
      display:none;
    }
    #logoutBtn:hover { background:#c0392b; }
  </style>
</head>

<body>
  <h1>GPT ë¼ì´ì„ ìŠ¤ ì¸ì¦</h1>

  <!-- Step 1 -->
  <div class="step">
    <label>ë¼ì´ì„ ìŠ¤ í‚¤</label>
    <input type="text" id="licenseKey" placeholder="êµ¬ë§¤ í›„ ë°›ì€ í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="checkLicense()">1. í‚¤ í™•ì¸</button>
  </div>

  <!-- Step 2 -->
  <div class="step">
    <button id="loginBtn" onclick="loginWithGoogle()" disabled>
      2. Google ë¡œê·¸ì¸
    </button>
    <p id="loginHint" style="font-size:0.9rem; color:#666;"></p>
  </div>

  <!-- Step 3 -->
  <div class="step">
    <button id="logoutBtn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
  </div>

  <p id="status"></p>
  <button id="closeBtn" style="display:none; margin-top:1rem;" onclick="window.close()">ì°½ ë‹«ê¸°</button>

  <script>
    const SUPABASE_URL = "https://ysfaaxlutynasreoegaf.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlzZmFheGx1dHluYXNyZW9lZ2FmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA5NDAyNjksImV4cCI6MjA3NjUxNjI2OX0.JD3iv2b1UG7xy69aIEp_2umF97GPRoeV0N7F1dJa6PM";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    let currentLicenseKey = "";

    window.addEventListener("load", async () => {
      // 1) ì €ì¥ëœ ë¼ì´ì„ ìŠ¤ í‚¤ ë³µêµ¬
      const savedKey = localStorage.getItem("licenseKey");
      if (savedKey) {
        currentLicenseKey = savedKey;
        document.getElementById("licenseKey").value = savedKey;
        document.getElementById("loginBtn").disabled = false;
        document.getElementById("loginHint").innerText = "ì´ë¯¸ í‚¤ê°€ ë“±ë¡ëœ ê²½ìš°, ë¡œê·¸ì¸ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.";
        setStatus("â„¹ï¸ ì €ì¥ëœ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.");
      }

      // 2) ë¡œê·¸ì¸ ì„¸ì…˜ í™•ì¸
      const { data } = await supabaseClient.auth.getSession();
      const session = data.session;
      if (!session) return;

      document.getElementById("logoutBtn").style.display = "inline-block";

      // 3) ì„¸ì…˜ + í‚¤ ìˆìœ¼ë©´ ìë™ activate
      if (!currentLicenseKey) {
        setStatus("âœ… ì´ë¯¸ ë¡œê·¸ì¸ëœ ìƒíƒœì…ë‹ˆë‹¤. í•„ìš” ì‹œ ë¡œê·¸ì•„ì›ƒ í›„ ë‹¤ì‹œ ë¡œê·¸ì¸í•˜ì„¸ìš”.");
        return;
      }

      setStatus("â³ ë¼ì´ì„ ìŠ¤ í™œì„±í™” ì¤‘...");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/activate`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${session.access_token}`
        },
        body: JSON.stringify({ license_key: currentLicenseKey })
      });

      const result = await res.json();

      if (!result.ok) {
        if (result.reason === "already_registered_to_other") {
          return setStatus("âš ï¸ ì´ ë¼ì´ì„ ìŠ¤ëŠ” ë‹¤ë¥¸ ê³„ì •ì— ì´ë¯¸ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.");
        }
        if (result.reason === "expired") {
          return setStatus("â° ë§Œë£Œëœ ë¼ì´ì„ ìŠ¤ì…ë‹ˆë‹¤. ìƒˆë¡œ êµ¬ë§¤í•´ ì£¼ì„¸ìš”.");
        }
        return setStatus("âŒ ë¼ì´ì„ ìŠ¤ í™œì„±í™” ì‹¤íŒ¨. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.");
      }

      // 4) entitlement í™•ì¸
      const entRes = await fetch(`${SUPABASE_URL}/functions/v1/entitlement`, {
        headers: {
          "apikey": SUPABASE_ANON_KEY,
          "Authorization": `Bearer ${session.access_token}`
        }
      });
      const ent = await entRes.json();

      if (!ent.valid) {
        return setStatus("âŒ ë¼ì´ì„ ìŠ¤ê°€ í™•ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
      }

      let countdown = 10;
      document.getElementById("closeBtn").style.display = "inline-block";

      const tick = () => {
        setStatus(
`âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!
ğŸ‘‰ GPT ì°½ì—ì„œ ì•„ë¬´ ë©”ì‹œì§€ë‚˜ ì…ë ¥í•˜ë©´ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.

${countdown}ì´ˆ í›„ ì°½ì´ ë‹«í™ë‹ˆë‹¤...`
        );
        countdown--;
        if (countdown < 0) window.close();
      };

      tick();
      const timer = setInterval(() => {
        if (countdown < 0) clearInterval(timer);
        else tick();
      }, 1000);
    });

    async function checkLicense() {
      const key = document.getElementById("licenseKey").value.trim();
      if (!key) return setStatus("âŒ ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.");

      setStatus("ğŸ”„ ë¼ì´ì„ ìŠ¤ í™•ì¸ ì¤‘...");

      const res = await fetch(`${SUPABASE_URL}/functions/v1/license-precheck`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "apikey": SUPABASE_ANON_KEY
        },
        body: JSON.stringify({ license_key: key })
      });

      const data = await res.json();

      if (data.status === "issued" || data.status === "active") {
        currentLicenseKey = key;
        localStorage.setItem("licenseKey", key);
        document.getElementById("loginBtn").disabled = false;
        return setStatus("âœ… ì‚¬ìš© ê°€ëŠ¥í•œ ë¼ì´ì„ ìŠ¤ í‚¤ì…ë‹ˆë‹¤.\nğŸ‘‰ Google ë¡œê·¸ì¸ì„ ì§„í–‰í•´ì£¼ì„¸ìš”.");
      }

      if (data.status === "expired") {
        return setStatus("â° ë§Œë£Œëœ ë¼ì´ì„ ìŠ¤ í‚¤ì…ë‹ˆë‹¤.");
      }

      setStatus("âŒ ì˜¬ë°”ë¥´ì§€ ì•Šì€ ë¼ì´ì„ ìŠ¤ í‚¤ì…ë‹ˆë‹¤.");
    }

    async function loginWithGoogle() {
      if (!currentLicenseKey) {
        return setStatus("âŒ ë¨¼ì € ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }

      setStatus("â³ Google ë¡œê·¸ì¸ ì§„í–‰ ì¤‘...");

      const { error } = await supabaseClient.auth.signInWithOAuth({
        provider: "google",
        options: {
          redirectTo: window.location.href,
          queryParams: { prompt: "select_account" }
        }
      });

      if (error) {
        setStatus("âŒ ë¡œê·¸ì¸ ì‹¤íŒ¨: " + error.message);
      }
    }

    async function logout() {
      await supabaseClient.auth.signOut();
      localStorage.removeItem("licenseKey");
      currentLicenseKey = "";
      document.getElementById("logoutBtn").style.display = "none";
      document.getElementById("loginBtn").disabled = false;
      setStatus("ğŸ‘‹ ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.");
    }

    function setStatus(msg) {
      document.getElementById("status").innerText = msg;
    }
  </script>
</body>
</html>
